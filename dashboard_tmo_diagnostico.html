<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard TMO â€“ Equipo de DiagnÃ³stico</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:20px; }
    h1 { color:#1f2937; }
    .filters, .kpis { display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
    .card { background:#fff; padding:15px 20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    .kpi { min-width:180px; }
    .kpi h2 { margin:0; font-size:28px; }
    .kpi span { color:#6b7280; font-size:14px; }
    canvas { background:#fff; padding:15px; border-radius:10px; }
  </style>
</head>
<body>

<h1>ðŸ“Š Cumplimiento TMO â€“ Equipo de DiagnÃ³stico</h1>
<p>Objetivo TMO: <strong>60 minutos</strong></p>

<div class="filters card">
  <div>
    <label>Agente</label><br>
    <select id="agentFilter">
      <option value="all">Todos</option>
    </select>
  </div>
  <div>
    <label>Desde</label><br>
    <input type="date" id="startDate" />
  </div>
  <div>
    <label>Hasta</label><br>
    <input type="date" id="endDate" />
  </div>
  <div>
    <label>Cargar archivo CSV</label><br>
    <input type="file" id="fileInput" accept=".csv" />
  </div>
</div>
  <div>
    <label>Cargar archivo CSV</label><br>
    <input type="file" id="fileInput" accept=".csv" />
  </div>
</div>

<div class="kpis">
  <div class="card kpi">
    <span>TMO Promedio</span>
    <h2 id="avgTmo">--</h2>
  </div>
  <div class="card kpi">
    <span>% Cumplimiento</span>
    <h2 id="compliance">--</h2>
  </div>
  <div class="card kpi">
    <span>Casos Totales</span>
    <h2 id="totalCases">--</h2>
  </div>
</div>

<canvas id="tmoChart" height="120"></canvas>

<script>
let rawData = [];
const TMO_OBJETIVO = 60;
let chart;

function parseCSV(text) {
  const lines = text.split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const values = line.split(",");
    let obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = values[i]);
    obj.TMO = parseFloat(obj.TMO);
    return obj;
  }).filter(r => !isNaN(r.TMO));
}

function updateFilters() {
  const agents = [...new Set(rawData.map(d=>d.Agente))];
  const select = document.getElementById("agentFilter");
  select.innerHTML = '<option value="all">Todos</option>';
  agents.forEach(a=>{
    const opt = document.createElement("option");
    opt.value=a; opt.textContent=a;
    select.appendChild(opt);
  });
}

function calculateMetrics(data) {
  const avg = data.reduce((s,d)=>s+d.TMO,0)/data.length || 0;
  const compliance = data.filter(d=>d.TMO<=TMO_OBJETIVO).length / data.length *100 || 0;
  return { avg, compliance, total:data.length };
}

function renderKPIs(metrics) {
  document.getElementById("avgTmo").textContent = metrics.avg.toFixed(1)+" min";
  document.getElementById("compliance").textContent = metrics.compliance.toFixed(1)+"%";
  document.getElementById("totalCases").textContent = metrics.total;
}

function renderChart(data) {
  const labels = data.map(d=>d.Fecha);
  const tmos = data.map(d=>d.TMO);

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("tmoChart"),{
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'TMO (min)', data:tmos, borderWidth:2 },
        { label:'Objetivo', data:labels.map(()=>TMO_OBJETIVO), borderDash:[5,5] }
      ]
    }
  });
}

function applyFilter() {
  const agent = document.getElementById("agentFilter").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  let filtered = rawData;

  if(agent !== 'all') {
    filtered = filtered.filter(d => d.Agente === agent);
  }

  if(start) {
    filtered = filtered.filter(d => d.Fecha >= start);
  }

  if(end) {
    filtered = filtered.filter(d => d.Fecha <= end);
  }

  const metrics = calculateMetrics(filtered);
  renderKPIs(metrics);
  renderChart(filtered);
}

// Eventos

document.getElementById("agentFilter").addEventListener("change", applyFilter);
document.getElementById("startDate").addEventListener("change", applyFilter);
document.getElementById("endDate").addEventListener("change", applyFilter);

document.getElementById("agentFilter").addEventListener("change", applyFilter);

document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    rawData = parseCSV(ev.target.result);
    updateFilters();
    applyFilter();
  };
  reader.readAsText(file);
});
</script>

<!--
Estructura esperada del CSV:
Fecha,Agente,TMO
2026-01-01,Ana Perez,55
2026-01-01,Carlos Ruiz,72
-->

</body>
</html>
